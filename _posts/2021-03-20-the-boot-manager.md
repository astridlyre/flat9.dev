---
layout: post
title: 'GRUB: The Linux Boot Manager'
date: 2021-03-20
categories: linux boot
---

The boot manager most often found on Linux-based systems is GRUB, the _Grand Unified Boot Loader_.
It is helpful to understand how to use GRUB in the event of a boot failure (say, due to a
failed kernel update, for instance). The legacy version of GRUB has been superseded by
GRUB2, a modern re-write of GRUB that aims to be cleaner, safer, more robust and more
powerful.

GRUB2 offers a more flexible configuration file, with many more commands and conditional
statements, akin to a scripting language. In addition, GRUB2 is more modular in design and
features better internationalization, themes and graphical boot menus. It is able to boot
LiveCD ISOs directly from a hard drive, offers better support for non-x86 architecture,
and has universal support for UUIDs, making it easier to identify storage devices.

## Where Is The Bootloader?

The _GRUB legacy bootloader_ is located on the first 512-byte sector of disk, known as the
_Master Boot Record_ (MBR). It contains bootstrap code that loads the bootloader and then
passes control to a secondary boot loader on disk, usually located in a 32 KB space
between the MBR and the first partition. MBR-based systems have a few limitations, such as
supporting a maximum of three primary partitions with one extended partition and a maximum
disk size of 2 TB.

To overcome these limitations, the _GUID Partition Table_ (GPT) was created. This is part
of the _Unified Extensible Firmware Interface_ (UEFI). GPT-partitioned disks can be used
either with a traditional PC-BIOS, or with UEFI firmware. On BIOS machines, the second
part of GRUB is stored in a special BIOS boot partition, while on UEFI firmware system
GRUB is loaded by the firmware from `grubia32.efi` (for 32-bit systems) or `grub64.efi`
(for 64-bit systems), from a partition called the _EFI System Partition_ (ESP).

## The `/boot` Partition

While a boot partition is not _required_ on modern systems, it is still good practice, as
it separates files needed for the boot process from the rest of the filesystem. The
`/boot` partition is typically the first partition on the disk, because of the way the
original PC BIOS addressed disks (using _Cylinders, Heads and Sectors_).

On x86-based systems, the `/boot` partition usually contains the following files:

- **Configuration file** called `config-VERSION` (where "VERSION" is the Linux kernel
  version), stores the configuration parameters for the Linux kernel. This is _automatically
  generated_ and should not be directly modified.
- **System map** is a look-up table matching symbol names (like variable or functions) to
  their corresponding position in memory. This can be useful when debugging a _kernel
  panic_. This file is usually named `System.map-VERSION`.
- **Linux kernel** is the operating system kernel, named `vmlinux-VERSION`, or if it is
  compressed `vmlinuz-VERSION`.
- **Initial RAM disk** contains a minimal root file system loaded into RAM that contains
  the utilities and kernel modules needed so the kernel can mount the "real" root
  filesystem. This file is usually named `initrd.img-VERSION`.
- **Bootloader-related files** are located in `/boot/grub` and includes the GRUB
  configuration file `/boot/grub/grub.cfg` (for GRUB2) or `/boot/grub/menu.lst` (for GRUB
  legacy), modules in `/boot/grub/i386-pc`, translation files in `/boot/grub/locale`, and
  fonts in `/boot/grub/fonts`.

## GRUB2

To install GRUB2 on a system, use the `grub-install` utility. If the system is
non-booting, use a [LiveCD](https://en.wikipedia.org/wiki/Live_CD) or rescue disk, find
out which is the boot partition for the system, mount it, and then run the install
utility. In order to list all partitions on the `/dev/sda` device, use `fdisk -l /dev/sda`.
When running the install utility, use `grub-install --boot-directory=/path/to/dir /dev/sda1`
if the system has a dedicated boot partition, or `grub-install --boot-directory=/boot /dev/sda1`
if it just has a `/boot` directory on the root filesystem.

### Configuring GRUB

The main configuration file is located in `/boot/grub/grub.cfg`. This file is
automatically generated by the `grub-mkconfig` command and should not be edited by hand.
To make changes to GRUB's configuration, edit the file `/etc/default/grub` and then run
the `update-grub` utility (which is a shortcut for `grub-mkconfig -o /boot/grub/grub.cfg`).

There are various options available in the `/etc/default/grub` configuration file,
including:

- `GRUB_DEFAULT=` which holds the default entry to boot. This can be numeric (0, 1, etc),
  the name of a menu entry (ie. `debian`), or `saved`, which is used in conjunction with
  `GRUB_SAVEDEFAULT=`. Menu entries are zero-based.
- `GRUB_SAFEDEFAULT=` takes a true or false option, if true (and if `GRUB_DEFAULT=saved`)
  then the default boot option will always be the last one selected in the boot menu.
- `GRUB_TIMEOUT=` takes a number of seconds before the default menu entry is selected. If
  set to `0`, the system will boot without showing a menu. If set it `-1`, the system waits
  until the user selects an option.
- `GRUB_CMDLINE_LINUX=` contains the default parameters to pass to the Linux kernel.
- `GRUB_CMDLINE_LINUX_DEFAULT=` allows the addition of extra parameters to the default
  entry, as two menu entries are generated for each kernel: one with default options and one
  for recovery.
- `GRUB_ENABLE_CRYPTODISK=` if set to `y`, commands like `grub-mkconfig`, `update-grub`
  and `grub-install` will look for encrypted disks and add the commands needed to access
  them during boot. Disables automatic booting, since a passphrase is _required_ to decrypt
  the drive.

To manage menu entries, the `update-grub` command scans for kernels and operating systems
on the machine and generates the corresponding entries in `/boot/grub/grub.cfg`. New
entries can be added manually via script files in the `/etc/grub.d/` directory. Custom
entry files should be executable and are processed in numerical order by `update-grub`.

The syntax for a menu entry is as follows:

```
menuentry "DefaultOS" {
  set root=(hd0,1)
  linux /vmlinuz root=/dev/sda1 ro quiet splash
  initrd /initrd.img
}
```

The first line always starts with `menuentry`, and the entry label is in quotation
marks. The command `set root` defines the disk and partition where the root filesystem is
located. In GRUB, disks are numbered from 0, while partitions are numbered from 1. Instead
of specifying the device, it is possible to use a label or UUID like `search --set-root --label LABEL`
or `seach --set-root --fd-uuid UUID`. To find the UUID of a disk, use `ls -l /dev/disk/by-uuid/`.
When using `search`, newer systems can add `--no-floppy` to avoid wasting time searching floppy disks.

### Interacting with GRUB

During boot, press `Shift` or `Esc` to bring up the GRUB menu. To exit a menu entry,
select the entry and press `e`. The contents of the `menuentry` associated with that
option will then become editable. After making changing, to boot with the new options
press `Ctrl+x` or `F10`. To return to the menu, press `Esc`.

GRUB also offers an interactive shell, which can be accessed using `c` at the menu,
or `Ctrl+c` while editing a `menuentry`. This interactive shell can be useful in case of
troubleshooting a misconfiguration. The shell enables booting the system after following
these steps:

1. Find out where the boot partition is with `ls` (shows list of the partitions).
2. Check the contents of boot partition to find the kernel and the initial RAM disk using
   the command `ls (hd0,msdos1)/`, or use the `-l` option for a long listing.
3. Set the boot partition with `set root=(hd0,msdos1)`.
4. Load the Linux kernel with `linux /vmlinuz root=/dev/sda1` (or whichever device it is).
5. Load the initial RAM disk with `initrd /initrd.img`.
6. Finally, try to boot the system with `boot`.

Note: The above commands closely resemble the steps for making a menu entry file in
`/etc/grub.d/`.

### The Rescue Shell

Similar to GRUB's interactive shell, the rescue shell is a simplified version and requires
almost the same steps as above to boot a machine, but some modules must be loaded first:

1. After finding the boot partition, specify the directory containing the GRUB2 files,
   using the command `set prefix=(hd0,msdos1)/boot/grub`.
2. Then, load the modules `normal` and `linux` using `insmod normal` and `insmod linux`.
3. Then proceed to set the boot partition, load the kernel, load the initrd and attempt to
   boot the system as above.

## Summary

The _Grand Unified Boot Loader_ (GRUB) is the ubiquitous boot manager on modern Linux
systems. When a system is working well, most people never have to worry about the boot
loader, but it is important to know some of the features GRUB provides, especially if the
need to troubleshoot a system arises.
